// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./database.sqlite"
}

model User {
  // ==========================================
  // DADOS DE IDENTIFICAÇÃO E ACESSO
  // ==========================================
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  roles        String   // Armazenado como JSON string (array de UserRole) - DEPRECATED: migrar para UserRoleAssignment
  isImported           Boolean @default(false)

  // ==========================================
  // DADOS DE ESTRUTURA ORGANIZACIONAL
  // ==========================================
  jobTitle     String   // Cargo/Posição do colaborador
  seniority    String   // Nível de senioridade
  careerTrack  String   // Trilha de carreira
  businessUnit String   // Unidade de negócio

  // ==========================================
  // DADOS DE ALOCAÇÃO E RELACIONAMENTO
  // ==========================================
  projects       String?  // Array de projetos (JSON string) - DEPRECATED: migrar para UserProjectAssignment
  managerId      String?  // ID do gestor direto
  directReports  String?  // Array de IDs dos liderados (JSON string)
  mentorId       String?  // ID do mentor designado

  // ==========================================
  // METADADOS DE CONTROLE
  // ==========================================
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // ==========================================
  // RELACIONAMENTOS COM AVALIAÇÕES (COMPATIBILIDADE)
  // ==========================================
  // Autoavaliações criadas pelo usuário
  selfAssessments SelfAssessment[]

  // Avaliações 360 criadas pelo usuário (como avaliador)
  assessments360Created Assessment360[] @relation("Assessment360Author")
  
  // Avaliações 360 recebidas pelo usuário (como avaliado)
  assessments360Received Assessment360[] @relation("Assessment360Evaluated")

  // Avaliações de mentoring criadas pelo usuário (como mentorado)
  mentoringAssessmentsCreated MentoringAssessment[] @relation("MentoringAssessmentAuthor")
  
  // Avaliações de mentoring recebidas pelo usuário (como mentor)
  mentoringAssessmentsReceived MentoringAssessment[] @relation("MentoringAssessmentMentor")

  // Feedbacks de referência criados pelo usuário (como autor)
  referenceFeedbacksCreated ReferenceFeedback[] @relation("ReferenceFeedbackAuthor")
  
  // Feedbacks de referência recebidos pelo usuário (como referenciado)
  referenceFeedbacksReceived ReferenceFeedback[] @relation("ReferenceFeedbackReferenced")

  // Avaliações de gestor criadas pelo usuário (como gestor)
  managerAssessmentsCreated ManagerAssessment[] @relation("ManagerAssessmentAuthor")
  
  // Avaliações de gestor recebidas pelo usuário (como liderado)
  managerAssessmentsReceived ManagerAssessment[] @relation("ManagerAssessmentEvaluated")

  // Avaliações de comitê criadas pelo usuário (como membro do comitê)
  committeeAssessmentsCreated CommitteeAssessment[] @relation("CommitteeAssessmentAuthor")
  
  // Avaliações de comitê recebidas pelo usuário (como avaliado)
  committeeAssessmentsReceived CommitteeAssessment[] @relation("CommitteeAssessmentEvaluated")

  // ==========================================
  // NOVOS RELACIONAMENTOS (ESTRUTURAS MELHORADAS)
  // ==========================================
  // Relacionamentos com novas estruturas
  roleAssignments    UserRoleAssignment[]
  projectAssignments UserProjectAssignment[]
  projectRoles       UserProjectRole[]  // NOVA: Roles específicas por projeto

  @@map("users")
}

// ==========================================
// TABELAS DE AVALIAÇÕES (COMPATIBILIDADE MANTIDA)
// ==========================================

model SelfAssessment {
  id          String   @id @default(cuid())
  cycle       String   // Ciclo de avaliação (ex: "2025.1") - FUTURO: migrar para FK evaluation_cycles
  authorId    String   // ID do usuário que criou a autoavaliação
  status      String   @default("DRAFT") // DRAFT | SUBMITTED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  submittedAt DateTime?
  isImported  Boolean @default(false)

  // Relacionamentos
  author  User                     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  answers SelfAssessmentAnswer[]

  @@unique([authorId, cycle]) // Um usuário só pode ter uma autoavaliação por ciclo
  @@map("self_assessments")
}

model SelfAssessmentAnswer {
  id               String @id @default(cuid())
  selfAssessmentId String
  criterionId      String // ID do critério (ex: "sentimento-de-dono") - FUTURO: migrar para FK criteria
  score            Int    // Nota de 1 a 5
  justification    String // Justificativa textual

  // Relacionamentos
  selfAssessment SelfAssessment @relation(fields: [selfAssessmentId], references: [id], onDelete: Cascade)

  @@unique([selfAssessmentId, criterionId]) // Uma resposta por critério por autoavaliação
  @@map("self_assessment_answers")
}

model Assessment360 {
  id               String   @id @default(cuid())
  cycle            String   // Ciclo de avaliação - FUTURO: migrar para FK evaluation_cycles
  authorId         String   // ID do usuário que criou a avaliação
  evaluatedUserId  String   // ID do usuário sendo avaliado
  overallScore     Int      // Nota geral de 1 a 5
  strengths        String   // Pontos fortes
  improvements     String   // Pontos de melhoria
  status           String   @default("DRAFT") // DRAFT | SUBMITTED
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  submittedAt      DateTime?
  isImported    Boolean @default(false)

  // Relacionamentos
  author        User @relation("Assessment360Author", fields: [authorId], references: [id], onDelete: Cascade)
  evaluatedUser User @relation("Assessment360Evaluated", fields: [evaluatedUserId], references: [id], onDelete: Cascade)

  @@unique([authorId, evaluatedUserId, cycle]) // Um usuário só pode avaliar outro uma vez por ciclo
  @@map("assessments_360")
}

model MentoringAssessment {
  id            String   @id @default(cuid())
  cycle         String   // Ciclo de avaliação - FUTURO: migrar para FK evaluation_cycles
  authorId      String   // ID do mentorado que criou a avaliação
  mentorId      String   // ID do mentor sendo avaliado
  score         Int      // Nota de 1 a 5
  justification String   // Justificativa da avaliação
  status        String   @default("DRAFT") // DRAFT | SUBMITTED
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  submittedAt   DateTime?
  isImported  Boolean @default(false)

  // Relacionamentos
  author User @relation("MentoringAssessmentAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  mentor User @relation("MentoringAssessmentMentor", fields: [mentorId], references: [id], onDelete: Cascade)

  @@unique([authorId, mentorId, cycle]) // Um mentorado só pode avaliar um mentor uma vez por ciclo
  @@map("mentoring_assessments")
}

model ReferenceFeedback {
  id                String   @id @default(cuid())
  cycle             String   // Ciclo de avaliação - FUTURO: migrar para FK evaluation_cycles
  authorId          String   // ID do usuário que criou o feedback
  referencedUserId  String   // ID do usuário sendo referenciado
  topic             String?  // Tópico do feedback (NOVO CAMPO)
  justification     String   // Feedback textual
  status            String   @default("DRAFT") // DRAFT | SUBMITTED
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  submittedAt       DateTime?
  isImported   Boolean @default(false)

  // Relacionamentos
  author         User @relation("ReferenceFeedbackAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  referencedUser User @relation("ReferenceFeedbackReferenced", fields: [referencedUserId], references: [id], onDelete: Cascade)

  @@unique([authorId, referencedUserId, cycle]) // Um usuário só pode referenciar outro uma vez por ciclo
  @@map("reference_feedbacks")
}

model ManagerAssessment {
  id               String   @id @default(cuid())
  cycle            String   // Ciclo de avaliação - FUTURO: migrar para FK evaluation_cycles
  authorId         String   // ID do gestor que criou a avaliação
  evaluatedUserId  String   // ID do liderado sendo avaliado
  status           String   @default("DRAFT") // DRAFT | SUBMITTED
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  submittedAt      DateTime?
  isImported    Boolean @default(false)

  // Relacionamentos
  author        User @relation("ManagerAssessmentAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  evaluatedUser User @relation("ManagerAssessmentEvaluated", fields: [evaluatedUserId], references: [id], onDelete: Cascade)
  answers       ManagerAssessmentAnswer[]

  @@unique([authorId, evaluatedUserId, cycle]) // Um gestor só pode avaliar um liderado uma vez por ciclo
  @@map("manager_assessments")
}

model ManagerAssessmentAnswer {
  id                    String @id @default(cuid())
  managerAssessmentId   String
  criterionId           String // ID do critério (ex: "sentimento-de-dono") - FUTURO: migrar para FK criteria
  score                 Int    // Nota de 1 a 5
  justification         String // Justificativa textual

  // Relacionamentos
  managerAssessment ManagerAssessment @relation(fields: [managerAssessmentId], references: [id], onDelete: Cascade)

  @@unique([managerAssessmentId, criterionId]) // Uma resposta por critério por avaliação de gestor
  @@map("manager_assessment_answers")
}

model CommitteeAssessment {
  id               String   @id @default(cuid())
  cycle            String   // Ciclo de avaliação - FUTURO: migrar para FK evaluation_cycles
  authorId         String   // ID do membro do comitê que criou a avaliação
  evaluatedUserId  String   // ID do colaborador sendo avaliado
  finalScore       Int      // Nota final de equalização (1 a 5)
  justification    String   // Justificativa da equalização
  observations     String?  // Observações adicionais
  status           String   @default("DRAFT") // DRAFT | SUBMITTED
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  submittedAt      DateTime?
  isImported    Boolean @default(false)

  // Relacionamentos
  author        User @relation("CommitteeAssessmentAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  evaluatedUser User @relation("CommitteeAssessmentEvaluated", fields: [evaluatedUserId], references: [id], onDelete: Cascade)

  @@unique([authorId, evaluatedUserId, cycle]) // Um membro do comitê só pode avaliar um colaborador uma vez por ciclo
  @@map("committee_assessments")
}

// ==========================================
// NOVAS ESTRUTURAS DE CONTROLE
// ==========================================

model EvaluationCycle {
  id        String           @id @default(cuid())
  name      String           @unique // Ex: "2025.1", "2025.2"
  status    CycleStatus      @default(UPCOMING)
  phase     EvaluationPhase  @default(ASSESSMENTS) // Nova fase do ciclo
  startDate DateTime?
  endDate   DateTime?
  isImported         Boolean @default(false)
  
  // NOVOS CAMPOS PARA DEADLINES
  assessmentDeadline    DateTime? // Prazo para autoavaliações e 360
  managerDeadline       DateTime? // Prazo para avaliações de gestor  
  equalizationDeadline  DateTime? // Prazo para equalização do comitê
  
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@map("evaluation_cycles")
}

model Criterion {
  id          String          @id @default(cuid()) // Ex: "sentimento-de-dono"
  name        String          // Ex: "Sentimento de Dono"
  description String          // Descrição detalhada do critério
  pillar      CriterionPillar // BEHAVIOR, EXECUTION, MANAGEMENT
  weight      Float           @default(1.0) // Peso do critério na avaliação (1.0 = 100%)
  isRequired  Boolean         @default(true) // Se o critério é obrigatório no formulário
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@map("criteria")
}

model Project {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  userAssignments UserProjectAssignment[]
  userProjectRoles UserProjectRole[]  // NOVA: Roles específicas por projeto

  @@map("projects")
}

// ==========================================
// TABELAS PIVÔS (RELACIONAMENTOS)
// ==========================================

model UserRoleAssignment {
  userId String
  role   UserRole

  // Relacionamentos
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, role])
  @@map("user_role_assignments")
}

model UserProjectAssignment {
  userId    String
  projectId String

  // Relacionamentos
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@id([userId, projectId])
  @@map("user_project_assignments")
}

// ==========================================
// NOVA FUNCIONALIDADE: ROLES POR PROJETO
// ==========================================

model UserProjectRole {
  id        String   @id @default(cuid())
  userId    String   // ID do usuário
  projectId String   // ID do projeto
  role      UserRole // Role do usuário neste projeto específico (gestor, colaborador, comite, rh, admin)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId, role]) // Um usuário pode ter múltiplas roles no mesmo projeto
  @@map("user_project_roles")
}

// ==========================================
// ENUMS
// ==========================================

enum UserRole {
  COLLABORATOR // colaborador
  MANAGER      // gestor
  MENTOR       // mentor
  COMMITTEE    // comite
  RH           // rh
  ADMIN        // admin
}

enum CriterionPillar {
  BEHAVIOR
  EXECUTION
  MANAGEMENT
}

enum EvaluationStatus {
  DRAFT
  SUBMITTED
  EQUALIZED
  CLOSED
}

enum CycleStatus {
  UPCOMING
  OPEN
  EQUALIZATION
  CLOSED
}

enum EvaluationPhase {
  ASSESSMENTS      // Fase 1: Autoavaliação, 360, Mentoring, Reference
  MANAGER_REVIEWS  // Fase 2: Avaliações de Gestor
  EQUALIZATION     // Fase 3: Equalização (ainda não implementada)
}


  // ==========================================
  // TABELAS DE IMPORTADOS
  // ==========================================


model ImportHistory {
  id                   String   @id @default(uuid())
  fileName             String
  fileSize             Float?
  uploadDate           DateTime @default(now())
  uploadedByEmail      String?
  overallStatus        String
  totalSheetsProcessed Int
  totalRecordsCreated  Int
  totalRecordsUpdated  Int
  totalErrors          Int
  details              Json? 

  perfisImportados      PerfilImportado[]
  autoAvaliacoesImportadas AutoAvaliacaoImportada[]
  avaliacoes360Importadas Avaliacao360Importada[]
  pesquisasReferenciaImportadas PesquisaReferenciaImportada[]

  @@map("import_history")
}

  // ==========================================
  // TABELAS DE DADOS IMPORTADOS
  // ==========================================

model PerfilImportado {
  id      String @id @default(uuid())
  nome    String @map("Nome ( nome.sobrenome )")
  email   String @unique
  ciclo   String @map("Ciclo (ano.semestre)")
  unidade String @map("Unidade")

  // Campo para a chave estrangeira
  importHistoryId String?
  importHistory             ImportHistory? @relation(fields: [importHistoryId], references: [id], onDelete: Cascade)

  @@map("perfis_importados")
}

model AutoAvaliacaoImportada {
  id                      String   @id @default(uuid())
  emailColaborador        String   @map("Email do Colaborador")
  ciclo                   String   @map("Ciclo (ano.semestre)")
  criterio                String   @map("CRITÉRIO")
  descricaoGeral          String   @map("DESCRIÇÃO GERAL")
  autoAvaliacao           Int?     @map("AUTO-AVALIAÇÃO")
  descricaoNota           String?  @map("DESCRIÇÃO NOTA")
  dadosFatosAutoAvaliacao String?  @map("DADOS E FATOS DA AUTO-AVALIAÇÃO\nCITE, DE FORMA OBJETIVA, CASOS E SITUAÇÕES REAIS")
  dataImportacao          DateTime @default(now())

  // Campo para a chave estrangeira
  importHistoryId String? 
  importHistory             ImportHistory? @relation(fields: [importHistoryId], references: [id], onDelete: Cascade)

  @@map("auto_avaliacoes_importadas")
}

model Avaliacao360Importada {
  id                           String   @id @default(uuid())
  emailColaborador             String   @map("Email do Colaborador")
  ciclo                        String   @map("Ciclo (ano.semestre)")
  emailAvaliado                String   @map("EMAIL DO AVALIADO ( nome.sobrenome )")
  projetoAtuadoJunto           String?  @map("PROJETO EM QUE ATUARAM JUNTOS - OBRIGATÓRIO TEREM ATUADOS JUNTOS")
  periodo                      String?  @map("PERÍODO")
  motivadoEmTrabalharNovamente String?  @map("VOCÊ FICARIA MOTIVADO EM TRABALHAR NOVAMENTE COM ESTE COLABORADOR")
  notaGeralColaborador         Float?   @map("DÊ UMA NOTA GERAL PARA O COLABORADOR")
  pontosMelhorar               String?  @map("PONTOS QUE DEVE MELHORAR")
  pontosExplorar               String?  @map("PONTOS QUE FAZ BEM E DEVE EXPLORAR")
  dataImportacao               DateTime @default(now())

  // Campo para a chave estrangeira
  importHistoryId String? 
  importHistory             ImportHistory? @relation(fields: [importHistoryId], references: [id], onDelete: Cascade)

  @@map("avaliacoes_360_importadas")
}

model PesquisaReferenciaImportada {
  id               String   @id @default(uuid())
  emailColaborador String   @map("Email do Colaborador")
  ciclo            String   @map("Ciclo (ano.semestre)")
  emailReferencia  String   @map("EMAIL DA REFERÊNCIA\n( nome.sobrenome )")
  justificativa    String?  @map("JUSTIFICATIVA")
  dataImportacao   DateTime @default(now())

  // Campo para a chave estrangeira
  importHistoryId String?
  importHistory             ImportHistory? @relation(fields: [importHistoryId], references: [id], onDelete: Cascade)

  @@map("pesquisas_referencia_importadas")
}