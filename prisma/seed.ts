import { PrismaClient } from '@prisma/client';
import * as bcrypt from 'bcryptjs';

const prisma = new PrismaClient();

async function main() {
  console.log('üå± Iniciando seed do banco de dados...');

  // ==========================================
  // SEED - EVALUATION CYCLES
  // ==========================================
  console.log('üìÖ Criando ciclos de avalia√ß√£o...');
  
  const cycles = [
    {
      id: '2024.2',
      name: '2024.2',
      status: 'CLOSED' as const,
      startDate: new Date('2024-07-01'),
      endDate: new Date('2024-12-31'),
    },
    {
      id: '2025.1',
      name: '2025.1', 
      status: 'OPEN' as const,
      startDate: new Date('2025-01-01'),
      endDate: new Date('2025-06-30'),
    },
    {
      id: '2025.2',
      name: '2025.2',
      status: 'UPCOMING' as const,
      startDate: new Date('2025-07-01'),
      endDate: new Date('2025-12-31'),
    },
  ];

  for (const cycle of cycles) {
    await prisma.evaluationCycle.upsert({
      where: { id: cycle.id },
      update: cycle,
      create: cycle,
    });
  }

  // ==========================================
  // SEED - CRITERIA (CRIT√âRIOS DE AVALIA√á√ÉO)
  // ==========================================
  console.log('üìã Criando crit√©rios de avalia√ß√£o...');

  const criteria = [
    // BEHAVIOR - Crit√©rios Comportamentais
    {
      id: 'sentimento-de-dono',
      name: 'Sentimento de Dono',
      description: 'Demonstra responsabilidade e cuidado com o trabalho e resultados da empresa',
      pillar: 'BEHAVIOR' as const,
    },
    {
      id: 'resiliencia-adversidades',
      name: 'Resili√™ncia nas Adversidades',
      description: 'Mant√©m-se firme e adapt√°vel diante de desafios e dificuldades',
      pillar: 'BEHAVIOR' as const,
    },
    {
      id: 'organizacao-trabalho',
      name: 'Organiza√ß√£o no Trabalho',
      description: 'Mant√©m organiza√ß√£o pessoal e estrutura√ß√£o eficiente das atividades',
      pillar: 'BEHAVIOR' as const,
    },
    {
      id: 'capacidade-aprender',
      name: 'Capacidade de Aprender',
      description: 'Busca constantemente novos conhecimentos e desenvolvimento pessoal',
      pillar: 'BEHAVIOR' as const,
    },
    {
      id: 'team-player',
      name: 'Ser "Team Player"',
      description: 'Trabalha efetivamente em equipe e contribui para um ambiente colaborativo',
      pillar: 'BEHAVIOR' as const,
    },

    // EXECUTION - Crit√©rios de Execu√ß√£o
    {
      id: 'entregar-qualidade',
      name: 'Entregar com Qualidade',
      description: 'Entrega trabalho com alta qualidade e aten√ß√£o aos detalhes',
      pillar: 'EXECUTION' as const,
    },
    {
      id: 'atender-prazos',
      name: 'Atender aos Prazos',
      description: 'Entrega tarefas e projetos dentro dos prazos estabelecidos',
      pillar: 'EXECUTION' as const,
    },
    {
      id: 'fazer-mais-menos',
      name: 'Fazer Mais com Menos',
      description: 'Maximiza resultados com recursos dispon√≠veis, otimizando efici√™ncia',
      pillar: 'EXECUTION' as const,
    },
    {
      id: 'pensar-fora-caixa',
      name: 'Pensar Fora da Caixa',
      description: 'Demonstra criatividade e inova√ß√£o na resolu√ß√£o de problemas',
      pillar: 'EXECUTION' as const,
    },

    // MANAGEMENT - Crit√©rios de Gest√£o e Lideran√ßa (para gestores)
    {
      id: 'gestao-gente',
      name: 'Gente',
      description: 'Desenvolve, motiva e lidera pessoas de forma eficaz',
      pillar: 'MANAGEMENT' as const,
    },
    {
      id: 'gestao-resultados',
      name: 'Resultados',
      description: 'Foca em resultados e entrega valor consistente para a organiza√ß√£o',
      pillar: 'MANAGEMENT' as const,
    },
    {
      id: 'evolucao-rocket-corp',
      name: 'Evolu√ß√£o da Rocket Corp',
      description: 'Contribui estrategicamente para o crescimento e evolu√ß√£o da empresa',
      pillar: 'MANAGEMENT' as const,
    },
  ];

  for (const criterion of criteria) {
    await prisma.criterion.upsert({
      where: { id: criterion.id },
      update: criterion,
      create: criterion,
    });
  }

  // ==========================================
  // SEED - PROJECTS
  // ==========================================
  console.log('üèóÔ∏è Criando projetos...');

  const projects = [
    {
      id: 'projeto-alpha',
      name: 'Projeto Alpha',
      description: 'Desenvolvimento da nova plataforma de vendas com React e Node.js',
    },
    {
      id: 'projeto-beta',
      name: 'Projeto Beta',
      description: 'Moderniza√ß√£o do sistema de RH com migra√ß√£o para microservi√ßos',
    },
    {
      id: 'projeto-gamma',
      name: 'Projeto Gamma',
      description: 'Implementa√ß√£o de BI e analytics com Power BI e Apache Spark',
    },
    {
      id: 'projeto-delta',
      name: 'Projeto Delta',
      description: 'Migra√ß√£o para cloud computing (AWS) e containeriza√ß√£o com Docker',
    },
    {
      id: 'projeto-mobile-app',
      name: 'App Mobile RocketCorp',
      description: 'Desenvolvimento do aplicativo m√≥vel nativo para iOS e Android',
    },
    {
      id: 'projeto-api-core',
      name: 'API Core',
      description: 'Refatora√ß√£o e otimiza√ß√£o da API principal do sistema',
    },
  ];

  for (const project of projects) {
    await prisma.project.upsert({
      where: { id: project.id },
      update: project,
      create: project,
    });
  }

  // ==========================================
  // LIMPEZA E CRIA√á√ÉO DE USU√ÅRIOS
  // ==========================================
  console.log('üßπ Limpando dados existentes...');
  await prisma.userProjectAssignment.deleteMany();
  await prisma.userRoleAssignment.deleteMany();
  await prisma.user.deleteMany();

  // Cria senha hasheada
  const password = 'password123';
  const hashedPassword = await bcrypt.hash(password, 10);

  console.log('üë• Criando usu√°rios robustos...');

  // ==========================================
  // USU√ÅRIO 1: ANA OLIVEIRA - DESENVOLVEDORA FRONTEND PLENO
  // ==========================================
  const ana = await prisma.user.create({
    data: {
      name: 'Ana Beatriz Oliveira Santos',
      email: 'ana.oliveira@rocketcorp.com',
      passwordHash: hashedPassword,
      roles: JSON.stringify(['colaborador']), // Campo legado - mantido para compatibilidade

      // Dados organizacionais completos
      jobTitle: 'Desenvolvedora Frontend',
      seniority: 'Pleno',
      careerTrack: 'Tecnologia',
      businessUnit: 'Digital Products',

      // Dados de projetos (legado - agora substitu√≠do por UserProjectAssignment + UserProjectRole)
      projects: JSON.stringify(['projeto-alpha', 'projeto-mobile-app']),
      managerId: null, // Ser√° preenchido ap√≥s criar Bruno
      directReports: null, // Ana n√£o tem liderados
      mentorId: null, // Ser√° preenchido ap√≥s criar Carla

      isActive: true,
    },
  });

  console.log(`‚úÖ Usu√°rio criado: ${ana.name} (${ana.email})`);

  // ==========================================
  // USU√ÅRIO 2: BRUNO MENDES - TECH LEAD S√äNIOR
  // ==========================================
  const bruno = await prisma.user.create({
    data: {
      name: 'Bruno Andr√© Mendes Carvalho',
      email: 'bruno.mendes@rocketcorp.com',
      passwordHash: hashedPassword,
      roles: JSON.stringify(['colaborador', 'gestor']),

      // Dados organizacionais completos
      jobTitle: 'Tech Lead S√™nior',
      seniority: 'S√™nior',
      careerTrack: 'Tecnologia',
      businessUnit: 'Digital Products',

      // Dados de projetos (legado - agora substitu√≠do por UserProjectAssignment + UserProjectRole)
      projects: JSON.stringify(['projeto-alpha', 'projeto-api-core', 'projeto-delta']),
      managerId: null, // Ser√° preenchido ap√≥s criar Carla
      directReports: JSON.stringify([]), // Ser√° atualizado ap√≥s criar Ana e Felipe
      mentorId: null, // Ser√° preenchido ap√≥s criar Carla

      isActive: true,
    },
  });

  console.log(`‚úÖ Usu√°rio criado: ${bruno.name} (${bruno.email})`);

  // ==========================================
  // USU√ÅRIO 3: CARLA DIAS - HEAD OF ENGINEERING PRINCIPAL
  // ==========================================
  const carla = await prisma.user.create({
    data: {
      name: 'Carla Regina Dias Fernandes',
      email: 'carla.dias@rocketcorp.com',
      passwordHash: hashedPassword,
      roles: JSON.stringify(['colaborador', 'comite']),

      // Dados organizacionais completos
      jobTitle: 'Head of Engineering',
      seniority: 'Principal',
      careerTrack: 'Tecnologia',
      businessUnit: 'Digital Products',

      // Dados de projetos e relacionamentos
      projects: JSON.stringify(['projeto-beta', 'projeto-gamma', 'projeto-delta']),
      managerId: null, // Carla n√£o tem gestor (C-Level)
      directReports: JSON.stringify([]), // Ser√° atualizado ap√≥s criar Bruno e Diana
      mentorId: null, // Carla n√£o tem mentor

      isActive: true,
    },
  });

  console.log(`‚úÖ Usu√°rio criado: ${carla.name} (${carla.email})`);

  // ==========================================
  // USU√ÅRIO 4: DIANA COSTA - PEOPLE & CULTURE MANAGER S√äNIOR
  // ==========================================
  const diana = await prisma.user.create({
    data: {
      name: 'Diana Cristina Costa Lima',
      email: 'diana.costa@rocketcorp.com',
      passwordHash: hashedPassword,
      roles: JSON.stringify(['colaborador', 'rh']),

      // Dados organizacionais completos
      jobTitle: 'People & Culture Manager',
      seniority: 'S√™nior',
      careerTrack: 'Neg√≥cios',
      businessUnit: 'Opera√ß√µes',

      // Dados de projetos e relacionamentos
      projects: JSON.stringify(['projeto-beta']), // Projeto de moderniza√ß√£o do RH
      managerId: null, // Ser√° preenchido ap√≥s atualizar Carla
      directReports: null, // Diana n√£o tem liderados diretos
      mentorId: null, // Ser√° preenchido ap√≥s atualizar Carla

      isActive: true,
    },
  });

  console.log(`‚úÖ Usu√°rio criado: ${diana.name} (${diana.email})`);

  // ==========================================
  // USU√ÅRIO 5: FELIPE SILVA - DESENVOLVEDOR BACKEND J√öNIOR
  // ==========================================
  const felipe = await prisma.user.create({
    data: {
      name: 'Felipe Augusto Silva Rodrigues',
      email: 'felipe.silva@rocketcorp.com',
      passwordHash: hashedPassword,
      roles: JSON.stringify(['colaborador']),

      // Dados organizacionais completos
      jobTitle: 'Desenvolvedor Backend',
      seniority: 'J√∫nior',
      careerTrack: 'Tecnologia',
      businessUnit: 'Digital Products',

      // Dados de projetos e relacionamentos
      projects: JSON.stringify(['projeto-api-core', 'projeto-mobile-app']),
      managerId: null, // Ser√° preenchido ap√≥s atualizar Bruno
      directReports: null, // Felipe n√£o tem liderados
      mentorId: null, // Ser√° preenchido ap√≥s atualizar Ana

      isActive: true,
    },
  });

  console.log(`‚úÖ Usu√°rio criado: ${felipe.name} (${felipe.email})`);

  // ==========================================
  // USU√ÅRIO 6: EDUARDO TECH - DEVOPS ENGINEER S√äNIOR (ADMIN)
  // ==========================================
  const eduardo = await prisma.user.create({
    data: {
      name: 'Eduardo Jos√© Ferreira da Silva',
      email: 'eduardo.tech@rocketcorp.com',
      passwordHash: hashedPassword,
      roles: JSON.stringify(['admin']),

      // Dados organizacionais completos
      jobTitle: 'DevOps Engineer',
      seniority: 'S√™nior',
      careerTrack: 'Tecnologia',
      businessUnit: 'Opera√ß√µes',

      // Dados de projetos e relacionamentos
      projects: JSON.stringify(['projeto-delta', 'projeto-gamma']), // Projetos de infraestrutura
      managerId: null, // Eduardo reporta diretamente ao CTO (n√£o presente no seed)
      directReports: null, // Eduardo n√£o tem liderados
      mentorId: null, // Eduardo n√£o tem mentor

      isActive: true,
    },
  });

  console.log(`‚úÖ Usu√°rio criado: ${eduardo.name} (${eduardo.email})`);

  // ==========================================
  // CONFIGURA√á√ÉO DE RELACIONAMENTOS HIER√ÅRQUICOS
  // ==========================================
  console.log('üîó Configurando relacionamentos hier√°rquicos...');

  // Ana: gestor = Bruno, mentor = Carla
  await prisma.user.update({
    where: { id: ana.id },
    data: {
      managerId: bruno.id,
      mentorId: carla.id,
    },
  });
  console.log(`‚úÖ Ana ‚Üí Gestor: ${bruno.name}, Mentor: ${carla.name}`);

  // Bruno: gestor = Carla, mentor = Carla, liderados = [Ana, Felipe]
  await prisma.user.update({
    where: { id: bruno.id },
    data: {
      managerId: carla.id,
      mentorId: carla.id,
      directReports: JSON.stringify([ana.id, felipe.id]),
    },
  });
  console.log(`‚úÖ Bruno ‚Üí Gestor: ${carla.name}, Mentor: ${carla.name}, Liderados: Ana e Felipe`);

  // Carla: liderados = [Bruno, Diana]
  await prisma.user.update({
    where: { id: carla.id },
    data: {
      directReports: JSON.stringify([bruno.id, diana.id]),
    },
  });
  console.log(`‚úÖ Carla ‚Üí Liderados: Bruno e Diana`);

  // Diana: gestor = Carla, mentor = Carla
  await prisma.user.update({
    where: { id: diana.id },
    data: {
      managerId: carla.id,
      mentorId: carla.id,
    },
  });
  console.log(`‚úÖ Diana ‚Üí Gestor: ${carla.name}, Mentor: ${carla.name}`);

  // Felipe: gestor = Bruno, mentor = Ana
  await prisma.user.update({
    where: { id: felipe.id },
    data: {
      managerId: bruno.id,
      mentorId: ana.id,
    },
  });
  console.log(`‚úÖ Felipe ‚Üí Gestor: ${bruno.name}, Mentor: ${ana.name}`);

  // ==========================================
  // CONFIGURA√á√ÉO DE ROLE ASSIGNMENTS (NOVAS ESTRUTURAS)
  // ==========================================
  console.log('üë• Configurando role assignments...');

  const roleAssignments = [
    // Ana: Colaboradora
    { userId: ana.id, role: 'COLLABORATOR' as const },
    
    // Bruno: Colaborador + Gestor
    { userId: bruno.id, role: 'COLLABORATOR' as const },
    { userId: bruno.id, role: 'MANAGER' as const },
    
    // Carla: Colaboradora + Comit√™
    { userId: carla.id, role: 'COLLABORATOR' as const },
    { userId: carla.id, role: 'COMMITTEE' as const },
    
    // Diana: Colaboradora + RH
    { userId: diana.id, role: 'COLLABORATOR' as const },
    { userId: diana.id, role: 'RH' as const },
    
    // Felipe: Colaborador
    { userId: felipe.id, role: 'COLLABORATOR' as const },
    
    // Eduardo: Admin
    { userId: eduardo.id, role: 'ADMIN' as const },
  ];

  for (const assignment of roleAssignments) {
    await prisma.userRoleAssignment.upsert({
      where: {
        userId_role: {
          userId: assignment.userId,
          role: assignment.role,
        },
      },
      update: {},
      create: assignment,
    });
  }

  // ==========================================
  // CONFIGURA√á√ÉO DE ATRIBUI√á√ïES DE PROJETO
  // ==========================================
  console.log('üìã Configurando atribui√ß√µes de projeto...');

  const projectAssignments = [
    // Ana: Projeto Alpha (plataforma de vendas) e Mobile App
    { userId: ana.id, projectId: 'projeto-alpha' },
    { userId: ana.id, projectId: 'projeto-mobile-app' },
    
    // Bruno: Projeto Alpha (liderar), API Core e Delta (infraestrutura)
    { userId: bruno.id, projectId: 'projeto-alpha' },
    { userId: bruno.id, projectId: 'projeto-api-core' },
    { userId: bruno.id, projectId: 'projeto-delta' },
    
    // Carla: Projetos estrat√©gicos (Beta, Gamma, Delta)
    { userId: carla.id, projectId: 'projeto-beta' },
    { userId: carla.id, projectId: 'projeto-gamma' },
    { userId: carla.id, projectId: 'projeto-delta' },
    
    // Diana: Projeto Beta (moderniza√ß√£o RH)
    { userId: diana.id, projectId: 'projeto-beta' },
    
    // Felipe: API Core e Mobile App (projetos de aprendizado)
    { userId: felipe.id, projectId: 'projeto-api-core' },
    { userId: felipe.id, projectId: 'projeto-mobile-app' },
    
    // Eduardo: Delta (cloud) e Gamma (infraestrutura BI)
    { userId: eduardo.id, projectId: 'projeto-delta' },
    { userId: eduardo.id, projectId: 'projeto-gamma' },
  ];

  for (const assignment of projectAssignments) {
    await prisma.userProjectAssignment.upsert({
      where: {
        userId_projectId: {
          userId: assignment.userId,
          projectId: assignment.projectId,
        },
      },
      update: {},
      create: assignment,
    });
  }

  // ==========================================
  // CONFIGURA√á√ÉO DE ROLES POR PROJETO (UserProjectRole)
  // ==========================================
  console.log('üîë Configurando roles espec√≠ficas por projeto...');

  const userProjectRoles = [
    // PROJETO ALPHA - Plataforma de Vendas
    { userId: ana.id, projectId: 'projeto-alpha', role: 'COLLABORATOR' as const },
    { userId: bruno.id, projectId: 'projeto-alpha', role: 'MANAGER' as const }, // Bruno √© gestor no Alpha
    
    // PROJETO BETA - Moderniza√ß√£o RH  
    { userId: carla.id, projectId: 'projeto-beta', role: 'COMMITTEE' as const }, // Carla √© comit√™ no Beta
    { userId: diana.id, projectId: 'projeto-beta', role: 'RH' as const }, // Diana √© RH no Beta
    
    // PROJETO GAMMA - BI e Analytics
    { userId: carla.id, projectId: 'projeto-gamma', role: 'MANAGER' as const }, // Carla √© gestora no Gamma
    { userId: eduardo.id, projectId: 'projeto-gamma', role: 'ADMIN' as const }, // Eduardo √© admin no Gamma
    
    // PROJETO DELTA - Cloud Migration
    { userId: bruno.id, projectId: 'projeto-delta', role: 'COLLABORATOR' as const }, // Bruno colaborador no Delta
    { userId: carla.id, projectId: 'projeto-delta', role: 'COMMITTEE' as const }, // Carla comit√™ no Delta
    { userId: eduardo.id, projectId: 'projeto-delta', role: 'MANAGER' as const }, // Eduardo gestor no Delta
    
    // PROJETO MOBILE APP
    { userId: ana.id, projectId: 'projeto-mobile-app', role: 'COLLABORATOR' as const }, // Ana colaboradora no Mobile
    { userId: felipe.id, projectId: 'projeto-mobile-app', role: 'COLLABORATOR' as const }, // Felipe colaborador no Mobile
    
    // PROJETO API CORE
    { userId: bruno.id, projectId: 'projeto-api-core', role: 'MANAGER' as const }, // Bruno gestor no API Core
    { userId: felipe.id, projectId: 'projeto-api-core', role: 'COLLABORATOR' as const }, // Felipe colaborador no API Core
  ];

  for (const userProjectRole of userProjectRoles) {
    await prisma.userProjectRole.upsert({
      where: {
        userId_projectId_role: {
          userId: userProjectRole.userId,
          projectId: userProjectRole.projectId,
          role: userProjectRole.role,
        },
      },
      update: {},
      create: userProjectRole,
    });
  }

  console.log('‚úÖ Estruturas de relacionamento configuradas!');

  // ==========================================
  // RESUMO FINAL
  // ==========================================
  console.log('‚úÖ Seed conclu√≠do com sucesso!');
  console.log('üìä Estruturas criadas:');
  console.log(`   - ${cycles.length} ciclos de avalia√ß√£o`);
  console.log(`   - ${criteria.length} crit√©rios (${criteria.filter(c => c.pillar === 'BEHAVIOR').length} comportamentais, ${criteria.filter(c => c.pillar === 'EXECUTION').length} execu√ß√£o, ${criteria.filter(c => c.pillar === 'MANAGEMENT').length} gest√£o)`);
  console.log(`   - ${projects.length} projetos`);
  console.log(`   - 6 usu√°rios com perfis completos`);
  console.log(`   - ${roleAssignments.length} atribui√ß√µes de role globais`);
  console.log(`   - ${projectAssignments.length} atribui√ß√µes de projeto`);
  console.log(`   - ${userProjectRoles.length} roles espec√≠ficas por projeto`);
  console.log('');
  console.log('üë• Usu√°rios dispon√≠veis para login:');
  console.log('  üìß ana.oliveira@rocketcorp.com - Senha: password123');
  console.log('     üë§ Ana Beatriz Oliveira Santos | üéØ Colaboradora | üíº Desenvolvedora Frontend Pleno | üè¢ Digital Products');
  console.log('  üìß bruno.mendes@rocketcorp.com - Senha: password123');
  console.log('     üë§ Bruno Andr√© Mendes Carvalho | üéØ Gestor + Colaborador | üíº Tech Lead S√™nior | üè¢ Digital Products');
  console.log('  üìß carla.dias@rocketcorp.com - Senha: password123');
  console.log('     üë§ Carla Regina Dias Fernandes | üéØ Comit√™ + Colaboradora | üíº Head of Engineering Principal | üè¢ Digital Products');
  console.log('  üìß diana.costa@rocketcorp.com - Senha: password123');
  console.log('     üë§ Diana Cristina Costa Lima | üéØ RH + Colaboradora | üíº People & Culture Manager S√™nior | üè¢ Opera√ß√µes');
  console.log('  üìß felipe.silva@rocketcorp.com - Senha: password123');
  console.log('     üë§ Felipe Augusto Silva Rodrigues | üéØ Colaborador | üíº Desenvolvedor Backend J√∫nior | üè¢ Digital Products');
  console.log('  üìß eduardo.tech@rocketcorp.com - Senha: password123');
  console.log('     üë§ Eduardo Jos√© Ferreira da Silva | üéØ Admin | üíº DevOps Engineer S√™nior | üè¢ Opera√ß√µes');
  console.log('');
  console.log('üè¢ Estrutura Organizacional:');
  console.log('  üëë Carla Dias (Head) ‚Üí Bruno Mendes (Tech Lead) ‚Üí Ana Oliveira & Felipe Silva');
  console.log('  üëë Carla Dias (Head) ‚Üí Diana Costa (RH)');
  console.log('  üîß Eduardo Tech (Admin - Independente)');
  console.log('');
  console.log('üéØ Tipos de Usu√°rio:');
  console.log('  ‚Ä¢ Colaborador: Participa como avaliado');
  console.log('  ‚Ä¢ Gestor: Avalia liderados + √© avaliado');
  console.log('  ‚Ä¢ Comit√™: Equaliza√ß√£o final + √© avaliado');
  console.log('  ‚Ä¢ RH: Configura√ß√£o e acompanhamento');
  console.log('  ‚Ä¢ Admin: Gerenciamento total do sistema');
  console.log('');
  console.log('üîë Exemplos de Roles por Projeto:');
  console.log('  ‚Ä¢ Ana: COLLABORATOR no Alpha e Mobile App');
  console.log('  ‚Ä¢ Bruno: MANAGER no Alpha/API Core, COLLABORATOR no Delta');
  console.log('  ‚Ä¢ Carla: MANAGER no Gamma, COMMITTEE no Beta/Delta');
  console.log('  ‚Ä¢ Eduardo: MANAGER no Delta, ADMIN no Gamma');
  console.log('  ‚Ä¢ Diana: RH no Beta');
  console.log('  ‚Ä¢ Felipe: COLLABORATOR no Mobile App e API Core');
}

main()
  .catch((e) => {
    console.error('‚ùå Erro durante o seed:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
